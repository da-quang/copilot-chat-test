<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="src/style.css" />
    <title>Copilot Studio – Test (Version A)</title>
  </head>
  <body>
    <main class="container">
      <h1>Hi friend, try edit me!</h1>

      <div id="webchat" role="main" aria-label="Chat"></div>
      <p id="status">Loading chat …</p>
      <pre id="log" style="max-width:720px;white-space:pre-wrap;word-break:break-word;"></pre>
    </main>

    <script>
      // === Konfiguration ===
      const tokenEndpoint =
        "https://default723bc5912bab4230910fe743f63dfb.c1.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr17c_testVolHighSpeed/directline/token?api-version=2022-03-01-preview";

      const styleOptions = {
        accent: "#6E28D9",
        backgroundColor: "#ffffff",
        bubbleBorderRadius: 12,
        bubbleBackground: "#F8FAFC",
        bubbleFromUserBackground: "#EDE0FF",
        bubbleFromUserBorderRadius: 12,
        sendBoxBackground: "#ffffff",
        sendBoxTextColor: "#111827",
        hideUploadButton: true
      };

      // === Hilfsfunktionen/Logging ===
      const statusEl = document.getElementById("status");
      const logEl = document.getElementById("log");
      const log = (...args) => {
        console.log(...args);
        logEl.textContent +=
          args.map(a => (typeof a === "string" ? a : JSON.stringify(a))).join(" ") + "\n";
      };
      const qsParam = (url, name) => {
        try { return (new URL(url)).searchParams.get(name); } catch { return null; }
      };

      // === Web Chat dynamisch laden (mit Fallbacks) ===
      const WEBCHAT_SOURCES = [
        "https://cdn.botframework.com/botframework-webchat/latest/webchat.js",
        "https://cdn.jsdelivr.net/npm/botframework-webchat@latest/dist/webchat.js",
        "https://unpkg.com/botframework-webchat@latest/dist/webchat.js"
      ];

      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = src;
          s.onload = () => resolve(src);
          s.onerror = () => reject(new Error("Failed to load " + src));
          document.head.appendChild(s);
        });
      }

      async function loadWebChatWithFallback() {
        for (const src of WEBCHAT_SOURCES) {
          try {
            log("Loading WebChat:", src);
            await loadScript(src);
            if (window.WebChat) {
              log("WebChat loaded from:", src);
              return true;
            }
            log("No window.WebChat after load:", src);
          } catch (e) {
            log("Load error:", e.message);
          }
        }
        return false;
      }

      // === Hauptlogik (Region + Token + Render) ===
      async function getRegionalDirectLineBase() {
        const envBase = tokenEndpoint.slice(0, tokenEndpoint.indexOf("/powervirtualagents"));
        const apiVer  = qsParam(tokenEndpoint, "api-version") || "2022-03-01-preview";
        const regUrl  = `${envBase}/powervirtualagents/regionalchannelsettings?api-version=${apiVer}`;

        log("GET", regUrl);
        const res = await fetch(regUrl);
        log("regionalchannelsettings status:", res.status);
        if (!res.ok) throw new Error("regionalchannelsettings failed: " + res.status);

        const json = await res.json();
        log("regionalchannelsettings json:", json);
        return json?.channelUrlsById?.directline || "https://directline.botframework.com/";
      }

      async function getConversationToken() {
        log("GET", tokenEndpoint);
        const res = await fetch(tokenEndpoint);
        log("token endpoint status:", res.status);
        if (!res.ok) throw new Error("token endpoint failed: " + res.status);
        const json = await res.json();
        log("token json:", { ...json, token: json.token ? "***" : null });
        if (!json?.token) throw new Error("No token in response.");
        return json.token;
      }

      async function initWebChat() {
        try {
          statusEl.textContent = "Loading Web Chat library…";
          const ok = await loadWebChatWithFallback();
          if (!ok || !window.WebChat) {
            throw new Error("Web Chat library could not be loaded from any source.");
          }

          statusEl.textContent = "Resolving region…";
          const directLineBase = await getRegionalDirectLineBase();

          statusEl.textContent = "Fetching token…";
          const token = await getConversationToken();

          statusEl.textContent = "Rendering chat…";
          const directLine = window.WebChat.createDirectLine({
            token,
            domain: `${directLineBase}v3/directline`
          });

          window.WebChat.renderWebChat(
            { directLine, styleOptions },
            document.getElementById("webchat")
          );

          statusEl.textContent = "Ready.";
          statusEl.style.color = "#22c55e";
        } catch (err) {
          statusEl.textContent = "Init error. Open DevTools for details.";
          statusEl.style.color = "#ef4444";
          log("Init error:", err);
        }
      }

      document.addEventListener("DOMContentLoaded", initWebChat);
    </script>
  </body>
